{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Lynkevo Insights{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="page-header">
        <h1>Analytics Dashboard</h1>
        <div class="page-actions">
            <span class="date-range">{{ date_range }}</span>
            <a href="{% url 'dashboard:kpi_overview' %}" class="btn btn-secondary">
                Back to Reports
            </a>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üéØ</div>
            <div class="metric-content">
                <h3>Total Reports</h3>
                <div class="metric-value">{{ total_reports }}</div>
                <div class="metric-label">Last 6 months</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">‚≠ê</div>
            <div class="metric-content">
                <h3>Top CSAT Score</h3>
                <div class="metric-value">
                    {% if top_csat_clients %}
                        {{ top_csat_clients.0.1|floatformat:1 }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-label">
                    {% if top_csat_clients %}
                        {{ top_csat_clients.0.0 }}
                    {% else %}
                        No data
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üìä</div>
            <div class="metric-content">
                <h3>Active Clients</h3>
                <div class="metric-value">{{ top_csat_clients|length }}</div>
                <div class="metric-label">With CSAT data</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üìà</div>
            <div class="metric-content">
                <h3>Trend</h3>
                <div class="metric-value">üìä</div>
                <div class="metric-label">Data visualization</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Monthly Trends -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Monthly Ticket Trends</h3>
                <p>Tickets received vs resolved over time</p>
            </div>
            <div class="chart-content">
                <canvas id="monthlyTrendsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- CSAT Trends -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Customer Satisfaction Trends</h3>
                <p>Average CSAT scores by month</p>
            </div>
            <div class="chart-content">
                <canvas id="csatTrendsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Client Performance -->
        <div class="chart-container full-width">
            <div class="chart-header">
                <h3>Client Performance Overview</h3>
                <p>Resolution rate vs CSAT score by client</p>
            </div>
            <div class="chart-content">
                <canvas id="clientPerformanceChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Performers Table -->
    {% if top_csat_clients %}
    <div class="top-performers-section">
        <h3>Top Performing Clients (CSAT)</h3>
        <div class="performers-grid">
            {% for client_name, csat_score in top_csat_clients %}
            <div class="performer-card">
                <div class="performer-rank">{{ forloop.counter }}</div>
                <div class="performer-info">
                    <h4>{{ client_name }}</h4>
                    <div class="performer-score">{{ csat_score|floatformat:1 }}%</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Analytics specific styles */
.analytics-page {
    max-width: 1400px;
    margin: 0 auto;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-8);
}

.metric-card {
    background: white;
    padding: var(--spacing-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
}

.metric-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.metric-content h3 {
    margin: 0 0 var(--spacing-2) 0;
    color: var(--gray-600);
    font-size: var(--font-size-sm);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metric-value {
    font-size: var(--font-size-3xl);
    font-weight: 700;
    color: var(--gray-900);
    line-height: 1;
}

.metric-label {
    color: var(--gray-500);
    font-size: var(--font-size-xs);
    margin-top: var(--spacing-1);
}

.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-8);
}

.chart-container {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    overflow: hidden;
}

.chart-container.full-width {
    grid-column: 1 / -1;
}

.chart-header {
    padding: var(--spacing-6);
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.chart-header h3 {
    margin: 0 0 var(--spacing-1) 0;
    color: var(--gray-900);
    font-size: var(--font-size-lg);
}

.chart-header p {
    margin: 0;
    color: var(--gray-600);
    font-size: var(--font-size-sm);
}

.chart-content {
    padding: var(--spacing-6);
    height: 300px;
    position: relative;
}

.chart-content canvas {
    max-height: 100%;
}

.top-performers-section {
    background: white;
    padding: var(--spacing-8);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
}

.top-performers-section h3 {
    margin-bottom: var(--spacing-6);
    color: var(--gray-900);
}

.performers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-4);
}

.performer-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding: var(--spacing-4);
    background: var(--gray-50);
    border-radius: var(--radius);
    border: 1px solid var(--gray-200);
}

.performer-rank {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--font-size-lg);
}

.performer-info h4 {
    margin: 0 0 var(--spacing-1) 0;
    font-size: var(--font-size-base);
    color: var(--gray-900);
}

.performer-score {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--success-color);
}

.date-range {
    background: var(--gray-100);
    color: var(--gray-600);
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: var(--radius);
    font-size: var(--font-size-sm);
    font-weight: 500;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .page-header {
        flex-direction: column;
        gap: var(--spacing-4);
        align-items: stretch;
    }
    
    .performers-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse data from Django
    const monthlyData = JSON.parse('{{ monthly_data|escapejs }}');
    const clientPerformanceData = JSON.parse('{{ client_performance|escapejs }}');
    
    // Prepare data for charts
    const months = Object.keys(monthlyData).sort();
    const ticketsReceived = months.map(month => monthlyData[month].tickets_received);
    const ticketsResolved = months.map(month => monthlyData[month].tickets_resolved);
    const csatScores = months.map(month => monthlyData[month].avg_csat);
    
    // Monthly Trends Chart
    const monthlyTrendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    new Chart(monthlyTrendsCtx, {
        type: 'line',
        data: {
            labels: months.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: 'Tickets Received',
                data: ticketsReceived,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }, {
                label: 'Tickets Resolved',
                data: ticketsResolved,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // CSAT Trends Chart
    const csatTrendsCtx = document.getElementById('csatTrendsChart').getContext('2d');
    new Chart(csatTrendsCtx, {
        type: 'line',
        data: {
            labels: months.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }),
            datasets: [{
                label: 'Average CSAT (%)',
                data: csatScores,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Client Performance Chart (Scatter plot)
    const clientNames = Object.keys(clientPerformanceData);
    const scatterData = clientNames.map(name => {
        const client = clientPerformanceData[name];
        return {
            x: client.resolution_rate,
            y: client.avg_csat,
            label: name
        };
    });
    
    const clientPerformanceCtx = document.getElementById('clientPerformanceChart').getContext('2d');
    new Chart(clientPerformanceCtx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Client Performance',
                data: scatterData,
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                borderColor: '#3b82f6',
                borderWidth: 2,
                pointRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return `${point.label}: ${point.x.toFixed(1)}% resolution, ${point.y.toFixed(1)}% CSAT`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Resolution Rate (%)'
                    },
                    beginAtZero: true,
                    max: 100
                },
                y: {
                    title: {
                        display: true,
                        text: 'Average CSAT (%)'
                    },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
});
</script>
{% endblock %}