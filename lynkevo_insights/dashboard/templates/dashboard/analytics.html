{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
.analytics-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6);
}

.analytics-header {
    text-align: center;
    margin-bottom: var(--space-8);
}

.analytics-title {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: var(--space-4);
}

.date-range {
    color: var(--gray-600);
    font-size: var(--text-lg);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.stat-card {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--gray-600);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-value {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--primary);
}

.charts-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-8);
    margin-bottom: var(--space-8);
}

.chart-container {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
}

.chart-title {
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: var(--space-4);
    text-align: center;
}

.chart-canvas {
    max-height: 300px;
}

.top-performers {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
}

.performers-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.performer-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    margin-bottom: var(--space-2);
    background: var(--gray-50);
    border-radius: var(--radius);
}

.performer-name {
    font-weight: 600;
    color: var(--gray-700);
}

.performer-score {
    font-weight: 700;
    color: var(--primary);
}

@media (max-width: 768px) {
    .charts-section {
        grid-template-columns: 1fr;
    }
    .analytics-container {
        padding: var(--space-4);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="analytics-header">
        <h1 class="analytics-title">Analytics Dashboard</h1>
        <p class="date-range">{{ date_range }}</p>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Reports</div>
            <div class="stat-value">{{ total_reports }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Clients</div>
            <div class="stat-value">{{ top_resolution_clients|length }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Period Covered</div>
            <div class="stat-value">6 Months</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Monthly Trends Chart -->
        <div class="chart-container">
            <h2 class="chart-title">Monthly Trends</h2>
            <canvas id="monthlyTrendsChart" class="chart-canvas"></canvas>
        </div>

        <!-- Client Performance Chart -->
        <div class="chart-container">
            <h2 class="chart-title">Client Performance</h2>
            <canvas id="clientPerformanceChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- Top Performers -->
    <div class="top-performers">
        <h2 class="chart-title">Top Performers by Resolution Rate</h2>
        <ul class="performers-list">
            {% for client_name, resolution_rate in top_resolution_clients %}
            <li class="performer-item">
                <span class="performer-name">{{ client_name }}</span>
                <span class="performer-score">{{ resolution_rate|floatformat:1 }}%</span>
            </li>
            {% empty %}
            <li class="performer-item">
                <span class="performer-name">No data available</span>
                <span class="performer-score">-</span>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Back to Dashboard -->
    <div style="text-align: center; margin-top: var(--space-8);">
        <a href="{% url 'dashboard:kpi_overview' %}" class="btn btn-primary">
            Back to Dashboard
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse data from Django context
    const monthlyData = JSON.parse('{{ monthly_data|escapejs }}');
    const clientPerformance = JSON.parse('{{ client_performance|escapejs }}');

    // Monthly Trends Chart
    const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    const monthlyLabels = Object.keys(monthlyData).sort();
    const ticketsReceived = monthlyLabels.map(month => monthlyData[month]?.tickets_received || 0);
    const ticketsResolved = monthlyLabels.map(month => monthlyData[month]?.tickets_resolved || 0);

    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: [
                {
                    label: 'Tickets Received',
                    data: ticketsReceived,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Tickets Resolved',
                    data: ticketsResolved,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Client Performance Chart
    const clientCtx = document.getElementById('clientPerformanceChart').getContext('2d');
    const clientNames = Object.keys(clientPerformance);
    const resolutionRates = clientNames.map(name => clientPerformance[name]?.resolution_rate || 0);

    new Chart(clientCtx, {
        type: 'bar',
        data: {
            labels: clientNames,
            datasets: [{
                label: 'Resolution Rate (%)',
                data: resolutionRates,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
});
</script>
{% endblock %}