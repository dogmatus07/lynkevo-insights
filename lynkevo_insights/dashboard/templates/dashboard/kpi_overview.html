{% extends 'base.html' %}
{% load static %}

{% block title %}KPI Dashboard - Lynkevo Insights{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">KPI Dashboard</h1>
        <p class="page-subtitle">Monitor and analyze customer service performance metrics</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'dashboard:dashboard_analytics' %}" class="btn btn-secondary">
            View Analytics
        </a>
        <a href="{% url 'dashboard:kpi_create' %}" class="btn btn-primary">
            Create Report
        </a>
    </div>
</div>

<!-- Summary Metrics -->
{% if summary_metrics.total_reports %}
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon">üìä</div>
        </div>
        <div class="metric-value">{{ summary_metrics.total_reports }}</div>
        <div class="metric-label">Total Reports</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon">üé´</div>
        </div>
        <div class="metric-value">{{ summary_metrics.total_tickets_received|default:0 }}</div>
        <div class="metric-label">Tickets Received</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon">‚úÖ</div>
        </div>
        <div class="metric-value">{{ summary_metrics.total_tickets_resolved|default:0 }}</div>
        <div class="metric-label">Tickets Resolved</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon">‚≠ê</div>
        </div>
        <div class="metric-value">
            {% if summary_metrics.avg_csat %}
                {{ summary_metrics.avg_csat|floatformat:1 }}%
            {% else %}
                N/A
            {% endif %}
        </div>
        <div class="metric-label">Average CSAT</div>
    </div>
</div>
{% endif %}

<!-- Filters -->
<div class="card">
    <div class="card-body">
        <form method="get" class="filters-form">
            <div style="display: flex; gap: var(--space-4); align-items: end; flex-wrap: wrap;">
                <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
                    <label for="client-select" class="form-label">Client</label>
                    <select name="client" id="client-select" class="form-control" onchange="this.form.submit()">
                        <option value="">All Clients</option>
                        {% for client in clients %}
                        <option value="{{ client.slug }}" {% if active_client == client.slug %}selected{% endif %}>
                            {{ client.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                    <label for="period-select" class="form-label">Period</label>
                    <select name="period" id="period-select" class="form-control" onchange="this.form.submit()">
                        <option value="">All Periods</option>
                        {% for value, label in period_choices %}
                        <option value="{{ value }}" {% if period_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                {% if active_client or period_filter %}
                <div style="margin-bottom: 0;">
                    <a href="{% url 'dashboard:kpi_overview' %}" class="btn btn-secondary btn-sm">
                        Clear Filters
                    </a>
                </div>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Reports Table -->
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Client</th>
                <th>Period</th>
                <th>Date Range</th>
                <th>Tickets</th>
                <th>Resolution Rate</th>
                <th>Avg Times</th>
                <th>CSAT</th>
                <th>Issues</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td>
                    <div style="font-weight: 600;">{{ report.client.name }}</div>
                </td>
                <td>
                    <span class="badge badge-{% if report.period == 'weekly' %}info{% else %}warning{% endif %}">
                        {{ report.get_period_display }}
                    </span>
                </td>
                <td>
                    <div style="font-size: var(--text-sm);">
                        {{ report.period_start|date:"M d" }} - {{ report.period_end|date:"M d, Y" }}
                    </div>
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: var(--space-1);">
                        <div><strong>{{ report.tickets_received }}</strong> received</div>
                        <div style="font-size: var(--text-xs); color: var(--gray-500);">
                            {{ report.tickets_resolved }} resolved, {{ report.tickets_still_open }} open
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge badge-{% if report.resolution_rate >= 90 %}success{% elif report.resolution_rate >= 70 %}warning{% else %}danger{% endif %}">
                        {{ report.resolution_rate }}%
                    </span>
                </td>
                <td>
                    <div style="font-size: var(--text-xs);">
                        {% if report.first_reply_time_avg %}
                            <div>FRT: {{ report.first_reply_time_avg }}</div>
                        {% endif %}
                        {% if report.resolution_time_avg %}
                            <div>RT: {{ report.resolution_time_avg }}</div>
                        {% endif %}
                        {% if not report.first_reply_time_avg and not report.resolution_time_avg %}
                            <span style="color: var(--gray-400);">N/A</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    {% if report.csat %}
                        <span class="badge badge-{% if report.csat >= 85 %}success{% elif report.csat >= 70 %}warning{% else %}danger{% endif %}">
                            {{ report.csat }}%
                        </span>
                    {% else %}
                        <span class="badge badge-secondary">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: var(--space-2); font-size: var(--text-xs);">
                        <span class="{% if report.refunds > 0 %}badge badge-danger{% else %}badge badge-secondary{% endif %}">
                            {{ report.refunds }} refunds
                        </span>
                        <span class="{% if report.chargebacks_opened > 0 %}badge badge-danger{% else %}badge badge-secondary{% endif %}">
                            {{ report.chargebacks_opened }} CB
                        </span>
                    </div>
                </td>
                <td>
                    <div style="display: flex; gap: var(--space-2);">
                        <button class="btn btn-sm btn-secondary" title="View Details">View</button>
                        <button class="btn btn-sm btn-secondary" title="Edit Report">Edit</button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">
                    <div class="empty-state" style="padding: var(--space-8);">
                        <div class="empty-state-icon">üìä</div>
                        <h3 class="empty-state-title">No reports found</h3>
                        <p class="empty-state-text">
                            {% if active_client or period_filter %}
                                No reports match your current filters. Try adjusting your criteria.
                            {% else %}
                                Get started by creating your first KPI report.
                            {% endif %}
                        </p>
                        <a href="{% url 'dashboard:kpi_create' %}" class="btn btn-primary">
                            Create Your First Report
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if reports and reports|length > 0 %}
<div style="text-align: center; margin-top: var(--space-4); color: var(--gray-500); font-size: var(--text-sm);">
    Showing {{ reports|length }} report{{ reports|length|pluralize }}
    {% if active_client_name %} for {{ active_client_name }}{% endif %}
    {% if period_filter %} ({{ period_filter }} reports){% endif %}
</div>
{% endif %}

<style>
.filters-form {
    margin: 0;
}

.table td {
    vertical-align: top;
}
</style>

{% endblock %}