{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="page-header">
    <h1>KPI Overview</h1>
    <div class="page-actions">
        <a href="{% url 'dashboard:analytics' %}" class="btn btn-secondary">üìä Analytics</a>
        <a href="{% url 'dashboard:kpi_create' %}" class="btn btn-primary">Add New Report</a>
    </div>
</div>

<!-- Summary Metrics -->
{% if summary_metrics.total_reports %}
<div class="summary-section">
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-icon">üìä</div>
            <div class="summary-content">
                <div class="summary-value">{{ summary_metrics.total_reports }}</div>
                <div class="summary-label">Total Reports</div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">üé´</div>
            <div class="summary-content">
                <div class="summary-value">{{ summary_metrics.total_tickets_received|default:0 }}</div>
                <div class="summary-label">Tickets Received</div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">‚úÖ</div>
            <div class="summary-content">
                <div class="summary-value">{{ summary_metrics.total_tickets_resolved|default:0 }}</div>
                <div class="summary-label">Tickets Resolved</div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">‚≠ê</div>
            <div class="summary-content">
                <div class="summary-value">
                    {% if summary_metrics.avg_csat %}
                        {{ summary_metrics.avg_csat|floatformat:1 }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="summary-label">Average CSAT</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="filters-section">
    <form method="get" class="filter-form">
        <div class="form-group">
            <label for="client-select">Client:</label>
            <select name="client" id="client-select" onchange="this.form.submit()" class="form-control">
                <option value="">All Clients</option>
                {% for client in clients %}
                <option value="{{ client.slug }}" {% if active_client == client.slug %}selected{% endif %}>
                    {{ client.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="period-select">Period:</label>
            <select name="period" id="period-select" onchange="this.form.submit()" class="form-control">
                <option value="">All Periods</option>
                {% for value, label in period_choices %}
                <option value="{{ value }}" {% if period_filter == value %}selected{% endif %}>
                    {{ label }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<div class="table-container">
    <table class="kpi-table">
        <thead>
            <tr>
                <th>Client</th>
                <th>Period</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Tickets (Received/Unresolved/Reopened)</th>
                <th>Resolved</th>
                <th>Still Open</th>
                <th>First Reply Time</th>
                <th>Resolution Time</th>
                <th>CSAT</th>
                <th>Refunds</th>
                <th>Chargebacks (Opened/Processed)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td class="client-cell">{{ report.client.name }}</td>
                <td>
                    <span class="period-badge period-{{ report.period }}">
                        {{ report.get_period_display }}
                    </span>
                </td>
                <td>{{ report.period_start|date:"M d, Y" }}</td>
                <td>{{ report.period_end|date:"M d, Y" }}</td>
                <td class="metrics-cell">
                    <span class="metric">{{ report.tickets_received }}</span> / 
                    <span class="metric warning">{{ report.tickets_unresolved }}</span> / 
                    <span class="metric info">{{ report.tickets_reopened }}</span>
                </td>
                <td class="metric success">{{ report.tickets_resolved }}</td>
                <td class="metric {% if report.tickets_still_open > 0 %}warning{% endif %}">
                    {{ report.tickets_still_open }}
                </td>
                <td>
                    {% if report.first_reply_time_avg %}
                        {{ report.first_reply_time_avg }}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if report.resolution_time_avg %}
                        {{ report.resolution_time_avg }}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if report.csat %}
                        <span class="csat-score csat-{{ report.csat|floatformat:0|cut:"." }}">
                            {{ report.csat }}%
                        </span>
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td class="metric {% if report.refunds > 0 %}danger{% endif %}">
                    {{ report.refunds }}
                </td>
                <td class="metrics-cell">
                    <span class="metric danger">{{ report.chargebacks_opened }}</span> / 
                    <span class="metric info">{{ report.chargebacks_processed }}</span>
                </td>
                <td class="actions-cell">
                    <button class="btn btn-sm btn-secondary" title="View Details">üëÅ</button>
                    <button class="btn btn-sm btn-primary" title="Edit">‚úèÔ∏è</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="13" class="no-data">
                    <div class="empty-state">
                        <h3>No reports found</h3>
                        <p>Start by creating your first KPI report</p>
                        <a href="{% url 'dashboard:kpi_create' %}" class="btn btn-primary">Create Report</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if reports %}
<div class="table-footer">
    <p class="results-count">Showing {{ reports|length }} report{{ reports|length|pluralize }}</p>
</div>
{% endif %}

<style>
/* Summary section styles */
.summary-section {
    margin-bottom: var(--spacing-8);
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-4);
}

.summary-card {
    background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
    padding: var(--spacing-5);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.summary-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.summary-value {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    line-height: 1;
}

.summary-label {
    color: var(--gray-600);
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-top: var(--spacing-1);
}

@media (max-width: 768px) {
    .summary-cards {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .summary-cards {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="table-container">
    <table class="kpi-table">
        <thead>
            <tr>
                <th>Client</th>
                <th>Period</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Tickets (Received/Unresolved/Reopened)</th>
                <th>Resolved</th>
                <th>Still Open</th>
                <th>First Reply Time</th>
                <th>Resolution Time</th>
                <th>CSAT</th>
                <th>Refunds</th>
                <th>Chargebacks (Opened/Processed)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td class="client-cell">{{ report.client.name }}</td>
                <td>
                    <span class="period-badge period-{{ report.period }}">
                        {{ report.get_period_display }}
                    </span>
                </td>
                <td>{{ report.period_start|date:"M d, Y" }}</td>
                <td>{{ report.period_end|date:"M d, Y" }}</td>
                <td class="metrics-cell">
                    <span class="metric">{{ report.tickets_received }}</span> / 
                    <span class="metric warning">{{ report.tickets_unresolved }}</span> / 
                    <span class="metric info">{{ report.tickets_reopened }}</span>
                </td>
                <td class="metric success">{{ report.tickets_resolved }}</td>
                <td class="metric {% if report.tickets_still_open > 0 %}warning{% endif %}">
                    {{ report.tickets_still_open }}
                </td>
                <td>
                    {% if report.first_reply_time_avg %}
                        {{ report.first_reply_time_avg }}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if report.resolution_time_avg %}
                        {{ report.resolution_time_avg }}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if report.csat %}
                        <span class="csat-score csat-{{ report.csat|floatformat:0|cut:"." }}">
                            {{ report.csat }}%
                        </span>
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td class="metric {% if report.refunds > 0 %}danger{% endif %}">
                    {{ report.refunds }}
                </td>
                <td class="metrics-cell">
                    <span class="metric danger">{{ report.chargebacks_opened }}</span> / 
                    <span class="metric info">{{ report.chargebacks_processed }}</span>
                </td>
                <td class="actions-cell">
                    <button class="btn btn-sm btn-secondary" title="View Details">üëÅ</button>
                    <button class="btn btn-sm btn-primary" title="Edit">‚úèÔ∏è</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="13" class="no-data">
                    <div class="empty-state">
                        <h3>No reports found</h3>
                        <p>Start by creating your first KPI report</p>
                        <a href="{% url 'dashboard:kpi_create' %}" class="btn btn-primary">Create Report</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if reports %}
<div class="table-footer">
    <p class="results-count">Showing {{ reports|length }} report{{ reports|length|pluralize }}</p>
</div>
{% endif %}

{% endblock %}