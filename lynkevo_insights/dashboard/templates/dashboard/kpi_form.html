{% extends 'base.html' %}
{% load static %}

{% block title %}Create KPI Report - Lynkevo Insights{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/feather-icons"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Create Weekly Customer Service Report</h1>
        <p class="page-subtitle">Complete customer service metrics and analysis report</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'dashboard:kpi_overview' %}" class="btn btn-secondary">
            <i data-feather="arrow-left" class="btn-icon"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="form-container">
    <div class="card form-card">
        <div class="card-body">
            <form method="POST" class="kpi-report-form" id="kpiReportForm">
                {% csrf_token %}
                
                <!-- Report Header -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i data-feather="calendar" class="section-icon"></i>
                            Report Information
                        </h3>
                        <p class="section-description">Basic reporting period and client information</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">
                                <i data-feather="briefcase" class="label-icon"></i>
                                Client / Shop
                            </label>
                            <select name="client" class="form-control" required>
                                <option value="">Select a client...</option>
                                <option value="pridola-uk">Pridola UK</option>
                                <option value="yakkyo-fr">Yakkyo FR</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">
                                <i data-feather="repeat" class="label-icon"></i>
                                Period Type
                            </label>
                            <select name="period" class="form-control" required>
                                <option value="">Select period...</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">
                                <i data-feather="calendar" class="label-icon"></i>
                                Start Date
                            </label>
                            <input type="date" name="period_start" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">
                                <i data-feather="calendar" class="label-icon"></i>
                                End Date
                            </label>
                            <input type="date" name="period_end" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <i data-feather="store" class="label-icon"></i>
                                Shop Name
                            </label>
                            <input type="text" name="shop_name" class="form-control" 
                                   placeholder="e.g., Pridola UK, Yakkyo France">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i data-feather="hash" class="label-icon"></i>
                                Slack Channel
                            </label>
                            <input type="text" name="slack_channel" class="form-control" 
                                   placeholder="#customer-service-weekly-update" 
                                   value="#customer-service-weekly-update">
                        </div>
                    </div>
                </div>

                <!-- 1. Key Metrics -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i data-feather="target" class="section-icon"></i>
                            1. Key Metrics
                        </h3>
                        <p class="section-description">Response times, resolution times, and ticket volume</p>
                    </div>
                    
                    <!-- Response Times -->
                    <div class="subsection">
                        <h4 class="subsection-title">Response & Resolution Times</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="clock" class="label-icon"></i>
                                    Average First Response Time
                                </label>
                                <input type="text" name="first_response_time_avg" class="form-control duration-input" 
                                       placeholder="18h 23m 5s or 01:23:05">
                                <div class="form-hint">
                                    <i data-feather="help-circle" class="hint-icon"></i>
                                    Format: HH:MM:SS or natural language (18h 23m 5s)
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="percent" class="label-icon"></i>
                                    SLA Response Rate (%)
                                </label>
                                <input type="number" name="first_response_sla_percentage" class="form-control" 
                                       step="0.01" min="0" max="100" placeholder="68.18">
                                <div class="form-hint">
                                    <i data-feather="help-circle" class="hint-icon"></i>
                                    Percentage responded within SLA (e.g., 6 hours)
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="clock" class="label-icon"></i>
                                    Average Resolution Time
                                </label>
                                <input type="text" name="resolution_time_avg" class="form-control duration-input" 
                                       placeholder="1d 13h 37m 28s">
                                <div class="form-hint">
                                    <i data-feather="help-circle" class="hint-icon"></i>
                                    Format: 1d 13h 37m 28s or HH:MM:SS for same day
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="percent" class="label-icon"></i>
                                    48h Resolution Rate (%)
                                </label>
                                <input type="number" name="resolution_48h_percentage" class="form-control" 
                                       step="0.01" min="0" max="100" placeholder="67.67">
                                <div class="form-hint">
                                    <i data-feather="help-circle" class="hint-icon"></i>
                                    Percentage resolved within 48 hours
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket Volume -->
                    <div class="subsection">
                        <h4 class="subsection-title">Ticket Volume</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="inbox" class="label-icon"></i>
                                    Total Tickets Received
                                </label>
                                <input type="number" name="tickets_received" class="form-control" 
                                       placeholder="1234" min="0">
                                <div class="form-hint">
                                    <i data-feather="help-circle" class="hint-icon"></i>
                                    Total support tickets opened (received + unresolved + reopened)
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="check-circle" class="label-icon"></i>
                                    Total Inquiries Resolved
                                </label>
                                <input type="number" name="tickets_resolved" class="form-control" 
                                       placeholder="425" min="0">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="alert-circle" class="label-icon"></i>
                                    Tickets Still Open
                                </label>
                                <input type="number" name="tickets_still_open" class="form-control" 
                                       placeholder="248" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="rotate-ccw" class="label-icon"></i>
                                    Tickets Reopened
                                </label>
                                <input type="number" name="tickets_reopened" class="form-control" 
                                       placeholder="0" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Weekly Highlights -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i data-feather="star" class="section-icon"></i>
                            2. Weekly Highlights
                        </h3>
                        <p class="section-description">Common requests, refunds, and chargeback information</p>
                    </div>
                    
                    <!-- Common Requests -->
                    <div class="subsection">
                        <div class="subsection-header">
                            <h4 class="subsection-title">Most Common Customer Requests</h4>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="addCommonRequest()">
                                <i data-feather="plus" class="btn-icon"></i>
                                Add Request Type
                            </button>
                        </div>
                        <div id="commonRequestsContainer" class="dynamic-section">
                            <!-- Dynamic content added here -->
                        </div>
                    </div>
                    
                    <!-- Refund & Chargeback Management -->
                    <div class="subsection">
                        <h4 class="subsection-title">Refund and Chargeback Management</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="dollar-sign" class="label-icon"></i>
                                    Total Refund Requests
                                </label>
                                <input type="number" name="total_refund_requests" class="form-control" 
                                       placeholder="173" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="credit-card" class="label-icon"></i>
                                    Chargebacks Processed
                                </label>
                                <input type="number" name="chargebacks_processed" class="form-control" 
                                       placeholder="8" min="0">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i data-feather="alert-triangle" class="label-icon"></i>
                                    Chargebacks Opened
                                </label>
                                <input type="number" name="chargebacks_opened" class="form-control" 
                                       placeholder="12" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Observations & Challenges -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i data-feather="eye" class="section-icon"></i>
                            3. Observations and Challenges
                        </h3>
                        <p class="section-description">Key observations, trends, and challenges faced</p>
                    </div>
                    
                    <!-- Positive Trends -->
                    <div class="subsection">
                        <div class="subsection-header">
                            <h4 class="subsection-title">Positive Trends</h4>
                            <button type="button" class="btn btn-sm btn-success" onclick="addPositiveTrend()">
                                <i data-feather="plus" class="btn-icon"></i>
                                Add Positive Trend
                            </button>
                        </div>
                        <div id="positiveTrendsContainer" class="dynamic-section">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <!-- Areas for Improvement -->
                    <div class="subsection">
                        <div class="subsection-header">
                            <h4 class="subsection-title">Areas for Improvement</h4>
                            <button type="button" class="btn btn-sm btn-warning" onclick="addImprovementArea()">
                                <i data-feather="plus" class="btn-icon"></i>
                                Add Improvement Area
                            </button>
                        </div>
                        <div id="improvementAreasContainer" class="dynamic-section">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <!-- Challenges -->
                    <div class="subsection">
                        <h4 class="subsection-title">Challenges Faced</h4>
                        <div class="form-group">
                            <label class="form-label">
                                <i data-feather="alert-octagon" class="label-icon"></i>
                                Describe any challenges
                            </label>
                            <textarea name="challenges_faced" class="form-control" rows="4" 
                                      placeholder="No major issues reported."></textarea>
                        </div>
                    </div>
                </div>

                <!-- 4. Ticket Categories Breakdown -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i data-feather="pie-chart" class="section-icon"></i>
                            4. Ticket Categories Breakdown
                        </h3>
                        <p class="section-description">Detailed breakdown by category and subcategory</p>
                    </div>
                    
                    <div class="subsection">
                        <div class="subsection-header">
                            <h4 class="subsection-title">Category Details</h4>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addTicketCategory()">
                                <i data-feather="plus" class="btn-icon"></i>
                                Add Category
                            </button>
                        </div>
                        <div id="ticketCategoriesContainer" class="dynamic-section">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i data-feather="file-text" class="section-icon"></i>
                            Additional Notes
                        </h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i data-feather="edit-3" class="label-icon"></i>
                            General Notes & Comments
                        </label>
                        <textarea name="notes" class="form-control" rows="4" 
                                  placeholder="Any additional information, context, or notes..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i data-feather="save" class="btn-icon"></i>
                        Create Report
                    </button>
                    <a href="{% url 'dashboard:kpi_overview' %}" class="btn btn-secondary btn-lg">
                        <i data-feather="x" class="btn-icon"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.form-container {
    max-width: 1000px;
    margin: 0 auto;
}

.form-card {
    box-shadow: var(--shadow-lg);
    border: 0;
}

.form-section {
    margin-bottom: var(--space-12);
    padding-bottom: var(--space-8);
    border-bottom: 1px solid var(--gray-200);
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
}

.section-header {
    margin-bottom: var(--space-8);
}

.section-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin: 0 0 var(--space-2) 0;
    font-size: var(--text-2xl);
    font-weight: 600;
    color: var(--gray-800);
}

.section-icon {
    width: 24px;
    height: 24px;
    color: var(--primary);
}

.section-description {
    color: var(--gray-600);
    font-size: var(--text-sm);
    margin: 0;
    padding-left: 36px;
}

.subsection {
    margin-bottom: var(--space-8);
    padding: var(--space-6);
    background-color: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.subsection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}

.subsection-title {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--gray-700);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
}

.form-group {
    margin-bottom: var(--space-6);
}

.form-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
    font-weight: 600;
    color: var(--gray-700);
    font-size: var(--text-sm);
}

.label-icon {
    width: 16px;
    height: 16px;
    color: var(--gray-500);
}

.form-label.required::after {
    content: '*';
    color: var(--error);
    margin-left: var(--space-1);
}

.form-control {
    width: 100%;
    padding: var(--space-4);
    border: 2px solid var(--gray-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    color: var(--gray-700);
    background-color: var(--white);
    transition: all var(--transition-base);
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 124, 137, 0.1);
}

.form-control::placeholder {
    color: var(--gray-400);
    font-style: italic;
}

.form-hint {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    margin-top: var(--space-2);
    color: var(--gray-500);
    font-size: var(--text-xs);
    line-height: 1.4;
}

.hint-icon {
    width: 12px;
    height: 12px;
    margin-top: 2px;
    flex-shrink: 0;
}

.dynamic-section {
    border: 2px dashed var(--gray-300);
    border-radius: var(--radius);
    padding: var(--space-4);
    min-height: 80px;
    background-color: var(--white);
}

.dynamic-item {
    display: flex;
    gap: var(--space-3);
    align-items: end;
    margin-bottom: var(--space-4);
    padding: var(--space-4);
    background-color: var(--gray-50);
    border-radius: var(--radius);
    border: 1px solid var(--gray-200);
}

.dynamic-item:last-child {
    margin-bottom: 0;
}

.form-actions {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: 2px

{% endblock %}